<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="WindowsSoftwareOrganizer.Views.Dialogs.AIAssistantWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:WindowsSoftwareOrganizer.Views.Dialogs"
    Title="AI 助手">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 自定义标题栏 -->
        <Grid x:Name="AppTitleBar" Height="48" Background="Transparent">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Margin="16,0,12,0" 
                    VerticalAlignment="Center"
                    Background="{ThemeResource AccentFillColorDefaultBrush}"
                    CornerRadius="4"
                    Width="24" Height="24">
                <FontIcon x:Name="TitleIcon" Glyph="&#xE99A;" 
                          FontSize="14" 
                          Foreground="White"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
            </Border>

            <TextBlock Grid.Column="1" 
                       x:Name="TitleText"
                       Text="AI 助手" 
                       Style="{StaticResource CaptionTextBlockStyle}"
                       VerticalAlignment="Center"/>
        </Grid>

        <!-- 主内容区 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="SidebarColumn" Width="260"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- 左侧边栏 -->
            <Border x:Name="SidebarBorder"
                    Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 收缩按钮 + 新建会话 -->
                    <Grid Margin="8,8,8,4">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Button x:Name="ToggleSidebarButton"
                                Click="ToggleSidebarButton_Click"
                                ToolTipService.ToolTip="收起侧边栏"
                                Background="Transparent"
                                BorderThickness="0"
                                Padding="10"
                                CornerRadius="6">
                            <FontIcon x:Name="ToggleIcon" Glyph="&#xE76B;" FontSize="14"/>
                        </Button>

                        <Button x:Name="NewChatButton"
                                Grid.Column="1"
                                Click="NewChatButton_Click"
                                HorizontalAlignment="Stretch"
                                Margin="4,0,0,0"
                                Padding="10,8"
                                CornerRadius="6"
                                Style="{StaticResource AccentButtonStyle}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE710;" FontSize="13"/>
                                <TextBlock x:Name="NewChatText" Text="新建会话" FontSize="13"/>
                            </StackPanel>
                        </Button>
                    </Grid>

                    <!-- 会话历史标题 -->
                    <TextBlock x:Name="HistoryTitle"
                               Grid.Row="1"
                               Text="会话历史" 
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Opacity="0.6"
                               Margin="14,8,14,6"/>

                    <!-- 会话历史列表 -->
                    <ListView x:Name="SessionListView"
                              Grid.Row="2"
                              ItemsSource="{x:Bind Sessions, Mode=OneWay}"
                              SelectionMode="Single"
                              SelectionChanged="SessionListView_SelectionChanged"
                              Padding="4,0"
                              RightTapped="SessionListView_RightTapped">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="local:ChatSession">
                                <Grid Padding="6,8" ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <FontIcon Glyph="&#xE8BD;" FontSize="13" Opacity="0.6" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1" 
                                               Text="{x:Bind Title, Mode=OneWay}" 
                                               TextTrimming="CharacterEllipsis"
                                               VerticalAlignment="Center"
                                               FontSize="13"/>
                                    <!-- 删除按钮（悬停显示） -->
                                    <Button Grid.Column="2"
                                            Tag="{x:Bind}"
                                            Click="DeleteSession_Click"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Padding="4"
                                            Opacity="0.5"
                                            VerticalAlignment="Center">
                                        <FontIcon Glyph="&#xE74D;" FontSize="11"/>
                                    </Button>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="Padding" Value="2"/>
                                <Setter Property="Margin" Value="4,1"/>
                                <Setter Property="CornerRadius" Value="6"/>
                                <Setter Property="MinHeight" Value="36"/>
                            </Style>
                        </ListView.ItemContainerStyle>
                    </ListView>

                    <!-- 底部快捷操作 -->
                    <StackPanel Grid.Row="3" Margin="0,4,0,8">
                        <MenuFlyoutSeparator Margin="10,0,10,6"/>
                        <Button x:Name="QuickActionsButton"
                                Click="QuickActionsButton_Click"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Left"
                                Margin="8,0"
                                Padding="10,8"
                                CornerRadius="6"
                                Background="Transparent">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <FontIcon Glyph="&#xE945;" FontSize="14"/>
                                <TextBlock x:Name="QuickActionsText" Text="快捷操作" FontSize="13"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- 收起状态的迷你侧边栏 -->
            <Border x:Name="MiniSidebar"
                    Visibility="Collapsed"
                    Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="0,0,1,0"
                    Width="48">
                <StackPanel VerticalAlignment="Top" Margin="0,8,0,0">
                    <Button Click="ToggleSidebarButton_Click"
                            ToolTipService.ToolTip="展开侧边栏"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="12"
                            HorizontalAlignment="Center">
                        <FontIcon Glyph="&#xE76C;" FontSize="14"/>
                    </Button>
                    <Button Click="NewChatButton_Click"
                            ToolTipService.ToolTip="新建会话"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="12"
                            HorizontalAlignment="Center"
                            Margin="0,4,0,0">
                        <FontIcon Glyph="&#xE710;" FontSize="14"/>
                    </Button>
                </StackPanel>
            </Border>

            <!-- 右侧聊天区域 -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 顶部信息栏 -->
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="18,10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Border Width="36" Height="36" CornerRadius="18"
                                Background="{ThemeResource AccentFillColorDefaultBrush}">
                            <FontIcon x:Name="ModuleIcon" Glyph="&#xE99A;" 
                                      FontSize="16" Foreground="White"/>
                        </Border>

                        <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                            <TextBlock x:Name="ModuleTitle" Text="AI 助手" 
                                       Style="{StaticResource BodyStrongTextBlockStyle}"
                                       FontSize="14"/>
                            <TextBlock x:Name="ModuleSubtitle" Text="" 
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Opacity="0.6"
                                       FontSize="12"/>
                        </StackPanel>

                        <Button Grid.Column="2" 
                                x:Name="ClearButton" 
                                Click="ClearButton_Click"
                                ToolTipService.ToolTip="清空当前会话"
                                Background="Transparent"
                                BorderThickness="0"
                                Padding="8">
                            <FontIcon Glyph="&#xE74D;" FontSize="13"/>
                        </Button>
                    </Grid>
                </Border>

                <!-- 聊天消息区域 -->
                <ScrollViewer x:Name="ChatScrollViewer" 
                              Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              Padding="18,10">
                    <ItemsControl x:Name="MessagesPanel" 
                                  ItemsSource="{x:Bind Messages, Mode=OneWay}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="local:AIMessageItem">
                                <Grid Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Width="30" Height="30" CornerRadius="15"
                                            Background="{x:Bind local:AIAssistantWindow.GetAvatarBrush(IsUser)}"
                                            VerticalAlignment="Top" Margin="0,0,10,0">
                                        <FontIcon Glyph="{x:Bind local:AIAssistantWindow.GetAvatarGlyph(IsUser)}"
                                                  FontSize="13" Foreground="White"/>
                                    </Border>

                                    <StackPanel Grid.Column="1" Spacing="3">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="{x:Bind local:AIAssistantWindow.GetSenderLabel(IsUser)}"
                                                       FontWeight="SemiBold" FontSize="12"/>
                                            <TextBlock Text="{x:Bind Timestamp}" 
                                                       FontSize="10" Opacity="0.4"/>
                                        </StackPanel>
                                        
                                        <!-- 文本消息 -->
                                        <Border Padding="11,8" CornerRadius="6"
                                                Background="{x:Bind local:AIAssistantWindow.GetMessageBackground(IsUser)}"
                                                HorizontalAlignment="Left" MaxWidth="540"
                                                Visibility="{x:Bind local:AIAssistantWindow.ShowIfText(MsgType)}">
                                            <TextBlock Text="{x:Bind Content, Mode=OneWay}"
                                                       TextWrapping="Wrap" 
                                                       IsTextSelectionEnabled="True"
                                                       LineHeight="19"
                                                       FontSize="13"/>
                                        </Border>

                                        <!-- 加载状态 -->
                                        <StackPanel Orientation="Horizontal" Spacing="8"
                                                    Visibility="{x:Bind local:AIAssistantWindow.ShowIfLoading(MsgType)}">
                                            <ProgressRing IsActive="True" Width="14" Height="14"/>
                                            <TextBlock Text="{x:Bind Content, Mode=OneWay}" 
                                                       Opacity="0.7" FontSize="12"/>
                                        </StackPanel>

                                        <!-- 工具调用消息 -->
                                        <Border Padding="9,5" CornerRadius="5"
                                                Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                                HorizontalAlignment="Left" MaxWidth="540"
                                                Visibility="{x:Bind local:AIAssistantWindow.ShowIfTool(MsgType)}">
                                            <TextBlock Text="{x:Bind Content, Mode=OneWay}"
                                                       FontFamily="Consolas" FontSize="11"
                                                       TextWrapping="Wrap" Opacity="0.8"/>
                                        </Border>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- 底部输入区域 -->
                <Border Grid.Row="2" 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="0,1,0,0"
                        Padding="18,10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="InputTextBox"
                                 PlaceholderText="输入你的需求，按 Enter 发送..."
                                 AcceptsReturn="False"
                                 KeyDown="InputTextBox_KeyDown"
                                 IsEnabled="{x:Bind IsInputEnabled, Mode=OneWay}"
                                 Padding="11,9"
                                 FontSize="13"
                                 CornerRadius="6"/>

                        <Button Grid.Column="1" Margin="8,0,0,0"
                                Click="SendButton_Click"
                                IsEnabled="{x:Bind IsInputEnabled, Mode=OneWay}"
                                Style="{StaticResource AccentButtonStyle}"
                                Padding="14,9"
                                CornerRadius="6">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <FontIcon Glyph="&#xE724;" FontSize="13"/>
                                <TextBlock Text="发送" FontSize="12"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <!-- 快捷操作浮层 -->
        <Popup x:Name="QuickActionsPopup" IsLightDismissEnabled="True">
            <Border Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="4"
                    Width="220">
                <StackPanel>
                    <TextBlock Text="快捷操作" 
                               Style="{StaticResource BodyStrongTextBlockStyle}"
                               Margin="10,6,10,8"
                               FontSize="13"/>
                    <StackPanel x:Name="QuickActionsPanel" Spacing="2"/>
                </StackPanel>
            </Border>
        </Popup>

        <!-- 会话右键菜单 -->
        <Popup x:Name="SessionContextMenu" IsLightDismissEnabled="True">
            <Border Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="6"
                    Padding="4"
                    Width="140">
                <StackPanel Spacing="2">
                    <Button x:Name="RenameSessionButton"
                            Click="RenameSession_Click"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Background="Transparent"
                            Padding="10,8"
                            CornerRadius="4">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <FontIcon Glyph="&#xE8AC;" FontSize="13"/>
                            <TextBlock Text="重命名" FontSize="12"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="DeleteSessionButton"
                            Click="DeleteSessionFromMenu_Click"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Background="Transparent"
                            Padding="10,8"
                            CornerRadius="4">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <FontIcon Glyph="&#xE74D;" FontSize="13"/>
                            <TextBlock Text="删除" FontSize="12"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
        </Popup>

        <!-- 重命名对话框 -->
        <Popup x:Name="RenamePopup" IsLightDismissEnabled="True">
            <Border Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="12"
                    Width="260">
                <StackPanel Spacing="10">
                    <TextBlock Text="重命名会话" FontWeight="SemiBold" FontSize="13"/>
                    <TextBox x:Name="RenameTextBox" 
                             PlaceholderText="输入新名称"
                             FontSize="13"
                             Padding="10,8"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                        <Button Click="CancelRename_Click" Padding="12,6" FontSize="12">取消</Button>
                        <Button Click="ConfirmRename_Click" 
                                Style="{StaticResource AccentButtonStyle}" 
                                Padding="12,6"
                                FontSize="12">确定</Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Popup>
    </Grid>
</Window>
