<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="WindowsSoftwareOrganizer.Views.FileManagerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:WindowsSoftwareOrganizer.Views"
    xmlns:vm="using:WindowsSoftwareOrganizer.ViewModels"
    xmlns:models="using:WindowsSoftwareOrganizer.Core.Models"
    xmlns:converters="using:WindowsSoftwareOrganizer.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="Transparent">

    <Page.Resources>
        <converters:SizeToStringConverter x:Key="SizeToStringConverter" />
        
        <!-- 目录项模板 - 可点击进入 -->
        <DataTemplate x:Key="DirectoryItemTemplate" x:DataType="models:DirectoryEntry">
            <Grid Padding="12,8" 
                  Background="Transparent"
                  CornerRadius="4">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" MinWidth="200" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="150" />
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE8B7;" FontSize="20" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="{x:Bind Name}" FontWeight="SemiBold" />
                        <TextBlock Text="双击打开" 
                                   Style="{StaticResource CaptionTextBlockStyle}" 
                                   Opacity="0.4"
                                   FontSize="10" />
                    </StackPanel>
                </StackPanel>
                <TextBlock Grid.Column="1" 
                           Text="" 
                           VerticalAlignment="Center" 
                           Opacity="0.5" />
                <TextBlock Grid.Column="2" 
                           Text="文件夹" 
                           VerticalAlignment="Center" 
                           Opacity="0.5" />
                <TextBlock Grid.Column="3" 
                           Text="{x:Bind ModifiedTime}" 
                           VerticalAlignment="Center" 
                           Opacity="0.7" />
            </Grid>
        </DataTemplate>

        <!-- 文件项模板 -->
        <DataTemplate x:Key="FileItemTemplate" x:DataType="models:FileEntry">
            <Grid Padding="12,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" MinWidth="200" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="150" />
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE8A5;" FontSize="16" Opacity="0.7" />
                    <TextBlock Text="{x:Bind Name}" VerticalAlignment="Center" />
                </StackPanel>
                <TextBlock Grid.Column="1" 
                           Text="{x:Bind Size, Converter={StaticResource SizeToStringConverter}}" 
                           VerticalAlignment="Center" 
                           Opacity="0.7" />
                <TextBlock Grid.Column="2" 
                           Text="{x:Bind Extension}" 
                           VerticalAlignment="Center" 
                           Opacity="0.7" />
                <TextBlock Grid.Column="3" 
                           Text="{x:Bind ModifiedTime}" 
                           VerticalAlignment="Center" 
                           Opacity="0.7" />
            </Grid>
        </DataTemplate>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Text="文件管理" 
                   Style="{StaticResource TitleTextBlockStyle}"
                   Margin="0,0,0,16" />

        <!-- Toolbar -->
        <Grid Grid.Row="1" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Navigation Buttons -->
            <Button Command="{x:Bind ViewModel.NavigateBackCommand}" 
                    ToolTipService.ToolTip="后退"
                    Padding="8">
                <FontIcon Glyph="&#xE72B;" FontSize="16" />
            </Button>

            <Button Grid.Column="1" 
                    Command="{x:Bind ViewModel.NavigateForwardCommand}" 
                    ToolTipService.ToolTip="前进"
                    Padding="8" Margin="4,0">
                <FontIcon Glyph="&#xE72A;" FontSize="16" />
            </Button>

            <Button Grid.Column="2" 
                    Command="{x:Bind ViewModel.NavigateUpCommand}" 
                    ToolTipService.ToolTip="上级目录"
                    Padding="8" Margin="0,0,4,0">
                <FontIcon Glyph="&#xE74A;" FontSize="16" />
            </Button>

            <Button Grid.Column="3" 
                    Command="{x:Bind ViewModel.RefreshCommand}" 
                    ToolTipService.ToolTip="刷新"
                    Padding="8">
                <FontIcon Glyph="&#xE72C;" FontSize="16" />
            </Button>

            <!-- Path Bar -->
            <TextBox Grid.Column="4" 
                     Text="{x:Bind ViewModel.CurrentPath, Mode=TwoWay}"
                     PlaceholderText="输入路径..."
                     Margin="16,0"
                     KeyDown="PathTextBox_KeyDown" />

            <!-- Search -->
            <AutoSuggestBox Grid.Column="5" 
                            PlaceholderText="搜索文件..."
                            QueryIcon="Find"
                            Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            QuerySubmitted="SearchBox_QuerySubmitted"
                            Width="200" />

            <!-- More Actions -->
            <DropDownButton Grid.Column="6" Margin="8,0,0,0">
                <FontIcon Glyph="&#xE712;" FontSize="16" />
                <DropDownButton.Flyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="大小分析" Command="{x:Bind ViewModel.AnalyzeSizeCommand}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE9D9;" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutItem Text="类型统计" Command="{x:Bind ViewModel.AnalyzeTypesCommand}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE8FD;" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutItem Text="AI 智能整理" Command="{x:Bind ViewModel.AnalyzeWithAICommand}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE945;" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutSeparator />
                        <MenuFlyoutItem Text="新建文件夹" Click="NewFolder_Click">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE8F4;" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutSeparator />
                        <ToggleMenuFlyoutItem Text="显示隐藏文件" 
                                              IsChecked="{x:Bind ViewModel.ShowHiddenFiles, Mode=TwoWay}" />
                    </MenuFlyout>
                </DropDownButton.Flyout>
            </DropDownButton>
        </Grid>

        <!-- Main Content -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Drive List -->
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="8"
                    Margin="0,0,8,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <TextBlock Text="位置" 
                               Style="{StaticResource BodyStrongTextBlockStyle}"
                               Margin="8,0,0,8" />

                    <ListView Grid.Row="1" 
                              x:Name="DriveListView"
                              ItemsSource="{x:Bind ViewModel.Drives, Mode=OneWay}"
                              SelectionMode="Single"
                              ItemClick="DriveListView_ItemClick"
                              IsItemClickEnabled="True">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:DriveEntry">
                                <StackPanel Orientation="Horizontal" Spacing="8" Padding="4">
                                    <FontIcon Glyph="&#xEDA2;" FontSize="16" />
                                    <StackPanel>
                                        <TextBlock Text="{x:Bind Name}" />
                                        <TextBlock Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.6">
                                            <Run Text="{x:Bind FreeSpace, Converter={StaticResource SizeToStringConverter}}" />
                                            <Run Text=" 可用" />
                                        </TextBlock>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Grid>
            </Border>

            <!-- Right Panel: File List -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Column Headers -->
                <Grid Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                      CornerRadius="8,8,0,0"
                      Padding="12,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" MinWidth="200" />
                        <ColumnDefinition Width="100" />
                        <ColumnDefinition Width="100" />
                        <ColumnDefinition Width="150" />
                    </Grid.ColumnDefinitions>

                    <Button Content="名称" 
                            HorizontalAlignment="Left"
                            Background="Transparent"
                            Command="{x:Bind ViewModel.SortByCommand}"
                            CommandParameter="{x:Bind vm:FileSortField.Name}" />
                    <Button Grid.Column="1" 
                            Content="大小" 
                            HorizontalAlignment="Left"
                            Background="Transparent"
                            Command="{x:Bind ViewModel.SortByCommand}"
                            CommandParameter="{x:Bind vm:FileSortField.Size}" />
                    <Button Grid.Column="2" 
                            Content="类型" 
                            HorizontalAlignment="Left"
                            Background="Transparent"
                            Command="{x:Bind ViewModel.SortByCommand}"
                            CommandParameter="{x:Bind vm:FileSortField.Type}" />
                    <Button Grid.Column="3" 
                            Content="修改日期" 
                            HorizontalAlignment="Left"
                            Background="Transparent"
                            Command="{x:Bind ViewModel.SortByCommand}"
                            CommandParameter="{x:Bind vm:FileSortField.ModifiedDate}" />
                </Grid>

                <!-- Combined Directory and File List -->
                <ScrollViewer Grid.Row="1"
                              Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                              CornerRadius="0,0,8,8">
                    <StackPanel>
                        <!-- Directories - 使用 ListView 支持更好的点击交互 -->
                        <ListView x:Name="DirectoriesListView"
                                  ItemsSource="{x:Bind ViewModel.Directories, Mode=OneWay}"
                                  ItemTemplate="{StaticResource DirectoryItemTemplate}"
                                  SelectionMode="Single"
                                  IsItemClickEnabled="True"
                                  ItemClick="DirectoriesListView_ItemClick"
                                  DoubleTapped="DirectoriesListView_DoubleTapped"
                                  RightTapped="DirectoriesListView_RightTapped">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Margin" Value="0,1" />
                                </Style>
                            </ListView.ItemContainerStyle>
                        </ListView>
                        
                        <!-- Files -->
                        <ListView x:Name="FilesListView"
                                  ItemsSource="{x:Bind ViewModel.Files, Mode=OneWay}"
                                  ItemTemplate="{StaticResource FileItemTemplate}"
                                  SelectionMode="Single"
                                  IsItemClickEnabled="True"
                                  ItemClick="FilesListView_ItemClick"
                                  DoubleTapped="FilesListView_DoubleTapped"
                                  RightTapped="FilesListView_RightTapped">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Margin" Value="0,1" />
                                </Style>
                            </ListView.ItemContainerStyle>
                        </ListView>
                        
                        <!-- Empty State -->
                        <StackPanel x:Name="EmptyState"
                                    Visibility="Collapsed"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Margin="0,48,0,0">
                            <FontIcon Glyph="&#xE8B7;" FontSize="48" Opacity="0.3" />
                            <TextBlock Text="此文件夹为空" 
                                       Style="{StaticResource BodyTextBlockStyle}"
                                       Opacity="0.5"
                                       Margin="0,16,0,0" />
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>

                <!-- Loading Overlay -->
                <Grid Grid.Row="1" 
                      Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                      Background="{ThemeResource LayerFillColorDefaultBrush}">
                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="16">
                        <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}" Width="48" Height="48" />
                        <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" 
                                   Style="{StaticResource BodyTextBlockStyle}" />
                    </StackPanel>
                </Grid>

                <!-- Progress Overlay -->
                <Grid Grid.Row="1" 
                      Visibility="{x:Bind ViewModel.ShowProgress, Mode=OneWay}"
                      Background="{ThemeResource LayerFillColorDefaultBrush}">
                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="16">
                        <ProgressRing IsActive="True" Width="48" Height="48" />
                        <TextBlock Text="{x:Bind ViewModel.ProgressText, Mode=OneWay}" 
                                   Style="{StaticResource BodyTextBlockStyle}" />
                        <ProgressBar Value="{x:Bind ViewModel.ProgressValue, Mode=OneWay}" 
                                     Width="200" />
                    </StackPanel>
                </Grid>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Grid Grid.Row="3" Margin="0,16,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" 
                       Style="{StaticResource CaptionTextBlockStyle}"
                       Opacity="0.7" />

            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16">
                <TextBlock Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.7">
                    <Run Text="{x:Bind ViewModel.TotalDirectoryCount, Mode=OneWay}" />
                    <Run Text="个文件夹，" />
                    <Run Text="{x:Bind ViewModel.TotalFileCount, Mode=OneWay}" />
                    <Run Text="个文件" />
                </TextBlock>
                <TextBlock Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.7">
                    <Run Text="总大小: " />
                    <Run Text="{x:Bind ViewModel.TotalSize, Mode=OneWay, Converter={StaticResource SizeToStringConverter}}" />
                </TextBlock>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
