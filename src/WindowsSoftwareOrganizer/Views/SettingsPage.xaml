<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="WindowsSoftwareOrganizer.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:WindowsSoftwareOrganizer.ViewModels"
    xmlns:models="using:WindowsSoftwareOrganizer.Core.Models"
    mc:Ignorable="d"
    Background="Transparent">

    <ScrollViewer Padding="24" HorizontalScrollBarVisibility="Disabled">
        <StackPanel Spacing="24" HorizontalAlignment="Stretch">
            <TextBlock Text="设置" 
                       Style="{StaticResource TitleTextBlockStyle}"
                       Margin="0,0,0,8" />

            <!-- 外观设置 -->
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="16">
                <StackPanel Spacing="16">
                    <TextBlock Text="外观" Style="{StaticResource SubtitleTextBlockStyle}" />
                    
                    <StackPanel Spacing="4">
                        <TextBlock Text="主题" Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.7" />
                        <ComboBox x:Name="ThemeComboBox"
                                  HorizontalAlignment="Stretch"
                                  SelectionChanged="ThemeComboBox_SelectionChanged">
                            <ComboBoxItem Content="跟随系统" Tag="Default" />
                            <ComboBoxItem Content="浅色" Tag="Light" />
                            <ComboBoxItem Content="深色" Tag="Dark" />
                        </ComboBox>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- OpenAI 配置 -->
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="16">
                <StackPanel Spacing="16">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <FontIcon Glyph="&#xE945;" FontSize="20" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                        <TextBlock Text="OpenAI / AI 配置" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>

                    <ToggleSwitch Header="启用 AI 功能"
                                  IsOn="{x:Bind ViewModel.OpenAIEnabled, Mode=TwoWay}"
                                  OnContent="已启用"
                                  OffContent="已禁用" />
                    
                    <StackPanel Spacing="4">
                        <TextBlock Text="API 密钥" Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.7" />
                        <PasswordBox Password="{x:Bind ViewModel.OpenAIApiKey, Mode=TwoWay}"
                                     PlaceholderText="sk-..."
                                     HorizontalAlignment="Stretch" />
                        <TextBlock Text="你的 OpenAI API 密钥，支持兼容 OpenAI 格式的其他服务" 
                                   Style="{StaticResource CaptionTextBlockStyle}" 
                                   Opacity="0.5" />
                    </StackPanel>

                    <StackPanel Spacing="4">
                        <TextBlock Text="API 地址" Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.7" />
                        <TextBox Text="{x:Bind ViewModel.OpenAIBaseUrl, Mode=TwoWay}"
                                 PlaceholderText="https://api.openai.com/v1"
                                 HorizontalAlignment="Stretch" />
                        <TextBlock Text="支持自定义端点，如 Azure OpenAI、本地部署等" 
                                   Style="{StaticResource CaptionTextBlockStyle}" 
                                   Opacity="0.5" />
                    </StackPanel>

                    <StackPanel Spacing="4">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="模型" Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.7" VerticalAlignment="Center" />
                            <Button Command="{x:Bind ViewModel.LoadModelsCommand}"
                                    Padding="4,2"
                                    ToolTipService.ToolTip="从 API 获取可用模型列表">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <ProgressRing IsActive="{x:Bind ViewModel.IsLoadingModels, Mode=OneWay}" 
                                                  Width="12" Height="12"
                                                  Visibility="{x:Bind ViewModel.IsLoadingModels, Mode=OneWay}" />
                                    <FontIcon Glyph="&#xE72C;" FontSize="12" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                        
                        <!-- 可编辑的 ComboBox，支持手动输入和下拉选择 -->
                        <ComboBox x:Name="ModelComboBox"
                                  ItemsSource="{x:Bind ViewModel.AvailableModels, Mode=OneWay}"
                                  HorizontalAlignment="Stretch"
                                  IsEditable="True"
                                  Text="{x:Bind ViewModel.OpenAIModel, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  DisplayMemberPath="DisplayName"
                                  PlaceholderText="输入或选择模型名称..." />
                        
                        <TextBlock Text="{x:Bind ViewModel.ModelsLoadStatus, Mode=OneWay}" 
                                   Style="{StaticResource CaptionTextBlockStyle}" 
                                   Opacity="0.5" />
                        <TextBlock Text="点击刷新按钮从 API 获取模型列表，或直接输入模型名称" 
                                   Style="{StaticResource CaptionTextBlockStyle}" 
                                   Opacity="0.4" />
                    </StackPanel>

                    <Grid ColumnSpacing="12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        
                        <Button Command="{x:Bind ViewModel.TestAPIConnectionCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <ProgressRing IsActive="{x:Bind ViewModel.IsTestingAPI, Mode=OneWay}" 
                                              Width="14" Height="14"
                                              Visibility="{x:Bind ViewModel.IsTestingAPI, Mode=OneWay}" />
                                <TextBlock Text="测试连接" />
                            </StackPanel>
                        </Button>
                        
                        <TextBlock Grid.Column="1" 
                                   Text="{x:Bind ViewModel.ApiTestResult, Mode=OneWay}"
                                   VerticalAlignment="Center"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   TextWrapping="Wrap" />
                    </Grid>
                </StackPanel>
            </Border>

            <!-- 默认路径 -->
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="16">
                <StackPanel Spacing="16">
                    <TextBlock Text="默认路径" Style="{StaticResource SubtitleTextBlockStyle}" />
                    
                    <Grid ColumnSpacing="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        
                        <TextBox Text="{x:Bind ViewModel.DefaultTargetPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 PlaceholderText="选择默认目标文件夹..." />
                        <Button Grid.Column="1" 
                                Command="{x:Bind ViewModel.BrowseTargetPathCommand}">
                            <FontIcon Glyph="&#xED25;" FontSize="16" />
                        </Button>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- 迁移选项 -->
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="16">
                <StackPanel Spacing="16">
                    <TextBlock Text="迁移选项" Style="{StaticResource SubtitleTextBlockStyle}" />
                    
                    <StackPanel Spacing="4">
                        <TextBlock Text="默认链接类型" Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.7" />
                        <ComboBox x:Name="LinkTypeComboBox"
                                  HorizontalAlignment="Stretch"
                                  SelectionChanged="LinkTypeComboBox_SelectionChanged">
                            <ComboBoxItem Content="Junction" Tag="Junction" />
                            <ComboBoxItem Content="Symbolic Link" Tag="SymbolicLink" />
                        </ComboBox>
                    </StackPanel>

                    <CheckBox Content="自动更新注册表" 
                              IsChecked="{x:Bind ViewModel.AutoUpdateRegistry, Mode=TwoWay}" />
                </StackPanel>
            </Border>

            <!-- 命名模板 -->
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="16">
                <StackPanel Spacing="16">
                    <TextBlock Text="命名模板" Style="{StaticResource SubtitleTextBlockStyle}" />
                    
                    <StackPanel Spacing="4">
                        <TextBlock Text="默认模板" Style="{StaticResource CaptionTextBlockStyle}" Opacity="0.7" />
                        <ComboBox ItemsSource="{x:Bind ViewModel.Templates}"
                                  SelectedItem="{x:Bind ViewModel.SelectedTemplate, Mode=TwoWay}"
                                  DisplayMemberPath="Name"
                                  HorizontalAlignment="Stretch" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- 保存按钮 -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="12">
                <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                           Style="{StaticResource CaptionTextBlockStyle}"
                           Opacity="0.7"
                           VerticalAlignment="Center" />
                <Button Content="保存设置"
                        Style="{StaticResource AccentButtonStyle}"
                        Command="{x:Bind ViewModel.SaveSettingsCommand}" />
            </StackPanel>
        </StackPanel>
    </ScrollViewer>
</Page>
